<!-- Libery -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Web Component -->
<link rel=*"import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../facebook-login-button/facebook-login-button.html">

<dom-module id="login-page">
  <template>
    <style is="custome-style" include="shared-styles">
      :host {
        position: fixed;
        top: 46px;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--primary-color);
        z-index: 150;
        color: var(--secondary-color);

        @apply(--layout);
        @apply(--layout-center-center);
      }
      .login-wrapper {
        margin-top: 40px;
        @apply(--layout-center-center);
        @apply(--layout-vertical);
      }
      .login-wrapper > *:not(:first-child) {
        margin-top: 50px;
      }
      paper-input {
        --paper-input-container-input-color: var(--secondary-color);
      }
      #loginButton {
        background-color: var(--secondary-color);
        color: var(--primary-color);
      }
      #loginButton[disabled] {
        color: #a8a8a8;
      }
    </style>
    <div class="login-wrapper">
      <form
        is="iron-form"
        id="form"
        method="post"
        action="[[_url]]"
        on-iron-form-response="_response"
        on-iron-form-error="_error">
        <paper-input name="email" value="{{email}}" label="E-mail" required></paper-input>
        <paper-input name="password" value="{{password}}" label="Password" type="password" required auto-validate></paper-input>
        <paper-button raised on-tap="_delayedSubmit" disabled id="loginButton">
          <paper-spinner id="spinner" hidden></paper-spinner>Submit
        </paper-button>
        <paper-button raised on-tap="_gotoSignup">Sign Up</paper-button>
        <div class="output"></div>
      </form>
      <facebook-login-button></facebook-login-button>
    </div>
  </template>
  <script>
    Polymer({
      is: 'login-page',
      properties: {
        _url: {
          type: String,
          value: function() {
            return window.api + '/api/login'
          }
        },
        page: {
          type: String,
          value: '',
        },
        email: {
          type: String
        },
        password: {
          type: String
        },
        hide: {
          type: Boolean,
          reflectToAttribute: true,
          value: false,
          computed: '_computeHide(page, _hasToken)'
        },
        _hasToken: {
          type: Boolean,
          value: false,
        },
        animationConfig: {
          value: function() {
            return {
              'exit': {
                name: 'fade-out-animation',
                node: this
              }
            }
          }
        }
      },

      behaviors: [
        Polymer.NeonAnimationRunnerBehavior,
      ],
      observers: [
        '_submitDisable(email,password)',
      ],
      listeners: {
        // this event is fired when the animation finishes
        'neon-animation-finish': '_onNeonAnimationFinish'
      },

      ready: function() {
        document.addEventListener('token', function(e) {
          this.set('_hasToken', !!token);
        }.bind(this));
      },
      _submitDisable: function(email, password) {
        this.$.loginButton.disabled = !email || !password;
      },
      _computeHide: function(page, _hasToken) {
        if (this._hasToken || page === 'signup') {
          this.playAnimation('exit');
        }
        return this._hasToken || page === 'signup';
      },
      _delayedSubmit: function(event) {
        var form = this.$.form;
        this.$.spinner.active = true;
        this.$.spinner.hidden = false;
        this.$.form.disabled = true;
        // Simulate a slow server response.
        form.submit();
      },
      _gotoSignup: function(event) {
        window.history.pushState({}, null, '/signup');
        window.dispatchEvent(new CustomEvent('location-changed'));
      },
      _response: function(e) {
        if (e.detail.response.success) {
          document.querySelector('chulaexpo-staff-app').token = e.detail.response.results.token;
        }
      },
      _error: function(e) {
        if (!e.detail.response.success) {

        }
      },
      _onNeonAnimationFinish: function() {
        if (this.hide) {
          this.style.display = 'none';
        }
      }
    });
  </script>
</dom-module>