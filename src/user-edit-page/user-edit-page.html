<!-- Libery -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Icon Component -->
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<!-- Web Component -->
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-grid/iron-grid.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-button-group/paper-button-group.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../user-api/user-api.html">
<link rel="import" href="../zone-api/zone-api.html">
<link rel="import" href="../profile-image-uploadable/profile-image-uploadable.html">
<dom-module id="user-edit-page">
  <template>
    <style is="custom-style" include="shared-styles">
      :host, paper-card {
        width: 100%;
      }
      :host {
        @apply(--layout);
        @apply(--layout-center-center);
      }
      @media (min-width: 600px) {
        :host {
          padding-top: 20px;
        }
      }
      .header {
        height: 140px;
        position: relative;
        background-color: var(--primary-color);
        margin-bottom: 60px;
        overflow: inherit!important;
      }
      .header * {
        overflow: inherit;
      }
      .center {
        @apply(--layout-center-justified);
        @apply(--layout-horizontal);
      }
      .offset {
        position: absolute;
        top: 40px;
        width: 100%;
      }
      [hidden] {
        display: none!important;
      }
      .item {
        display: block;
        padding: 8px 0;
      }
      .input-label {
        width: 55px;
        display: inline-block;
        margin-right: 16px;
        line-height: 46px;
        color: #888;
      }
      paper-dropdown-menu {
        width: 100%;
      }
      paper-button[toggles] {
        transition: background-color 0.3s;
      }
      paper-button[toggles][active] {
        color: white;
        background-color: var(--primary-color);
        --paper-button-flat-focus-color: var(--secondary-color);
      }
      paper-button.ripple::shadow paper-ripple {
        color: var(--primary-color);
      }
      paper-button.ripple paper-ripple {
        color: var(--primary-color);
      }
      .field {
        border: 1px dashed;
        border-radius: 5px;
        margin-top: 10px;
      }
      .button-holder {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        margin-top: 10px;
      }
      .error-msg {
        color: #ff5050;
        text-align: center;
        font-size: 1em;
      }
    </style>
    <user-api
      id="userAPI"
			target-id="{{userId}}"
			page="0"
			page-size="0"
			user="{{user}}"
    ></user-api>
    <zone-api
      id="zoneAPI"
			fields="_id,nameEN"
			page="0"
			page-size="0"
			zones="{{zones}}"
    ></zone-api>
    <form
      is="iron-form"
      id="form"
      method="post"
      action="{{_url}}"
      on-iron-form-presubmit="_presubmit"
      on-iron-form-response="_response"
      on-iron-form-reset="_reset"
      on-iron-form-error="_error"
      on-iron-form-invalid="_error"
      headers="[[headers]]">
      <paper-card class="container">
        <iron-a11y-keys id="a11y" target="[[_target]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
        <div class="header style-scope paper-card">
          <!-- Profile Image with uploadility -->
          <div class="center offset">
            <profile-image-uploadable image="{{user.profile}}" alt="User profile" name="profile"></profile-image-uploadable>
          </div>
        </div>
        <!-- Polymer Iron form -->
        <div class="card-content">
            <!-- Name -->
            <paper-input name="name" label="ชื่อ" value="{{user.name}}" required always-float-label></paper-input>
            <!-- E-mail -->
            <paper-input name="email" label="อีเมลล์" value="{{user.email}}" required always-float-label></paper-input>
            <!-- Password -->
            <paper-input id="password" name="password" label="พาสเวิร์ด" type="password" hidden$={{user.facebook}} required={{!user.facebook}} always-float-label></paper-input>
            <paper-input-container always-float-label attr-for-value="value"  hidden$={{user.facebook}}>
              <label>คอนเฟิร์มพาสเวิร์ด</label>
              <input
                id="confirmPassword"
                is="iron-input"
                class="paper-input-input"
                name="confirmPassword"
                type="password"
                required="{{!user.facebook}}"
                validator="confirmPasswordValidate"
              ></input>
              <paper-input-error>Password isn't macth</paper-input-error>
            </paper-input-container>
            <!-- Gender -->
            <div class="item">
              <div class="input-label" id="gender">เพศ:</div>
              <paper-button-group selected="{{user.gender}}">
                <paper-button name="Male" toggles active={{male}}>ชาย</paper-button>
                <paper-button name="Female" toggles active={{female}}>หญิง</paper-button>
                <paper-button name="Other" toggles active={{other}}>อื่นๆ</paper-button>
              </paper-button-group>
            </div>
            <!-- Age -->
            <paper-input name="age" label="อายุ" type="number" value="{{user.age}}" required always-float-label></paper-input>
            <div class="item">
              <!-- Student/Worker -->
              <div class="input-label">ประเภท:</div>
              <paper-button-group selected="{{user.type}}">
                <paper-button name="Academic" toggles active={{student}}>นักเรียน นิสิต</paper-button>
                <paper-button name="Worker" toggles active={{worker}}>บุคคลทั่วๆ</paper-button>
                <paper-button name="Staff" toggles active={{staff}}>สตาฟ</paper-button>
              </paper-button-group>
              <!-- Student -->
              <fieldset class="field" hidden$="{{!student}}">
<<<<<<< HEAD
                <paper-dropdown-menu name="academicLevel" label="การศึกษาปัจจุบัน" required="{{student}}">
                  <paper-listbox class="dropdown-content" selected="{{academicLevel}}">
                    <template is="dom-repeat" items="{{academicLevels}}">
                      <paper-item value="{{item}}">{{item}}</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                
                <paper-dropdown-menu name="academicYear" label="ชั้นปี" required="{{student}}">
                  <paper-listbox class="dropdown-content" selected="{{academicYear}}">
                    <template is="dom-repeat" items="{{academicYears}}">
                      <paper-item value="{{item}}">{{item}}</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-input name="academicSchool" label="สถาบันการศึกษา" value="{{user.academic.school}}" required="{{student}}" always-float-label></paper-input>
              </fieldset>
              <!-- Worker -->
              <fieldset class="field" hidden$="{{!worker}}">
                <vaadin-combo-box
                  name="workerJob"
                  label="อาชีพ"
                  items="[[workerJobs]]"
                  value="{{user.worker.job}}"
                  require="{{worker}}"
                  always-float-label></vaadin-combo-box>
              </fieldset>
              <!-- Staff -->
              <fieldset class="field" hidden$="{{!staff}}">
                <div class="item">
                  <div class="input-label">ประเภท:</div>
                  <paper-button-group selected="{{user.staff.staffType}}">
                    <paper-button toggles name="Admin" active="{{adminStaff}}">Admin</paper-button>
                    <paper-button toggles name="Scanner" active="{{scannerStaff}}">Scan man</paper-button>
                    <paper-button toggles name="Staff" active="{{staffStaff}}">Staff</paper-button>
                  </paper-button-group>
                </div>
                <paper-input-container always-float-label attr-for-value="value" id="code">
                  <label>รหัสลทะเบียน</label>
                  <input
                    is="iron-input"
                    class="paper-input-input"
                    name="registrationCode"
                    required="{{staff}}"
                  ></input>
                  <paper-input-error>Invalid Registration Code</paper-input-error>
                </paper-input-container>
                <vaadin-combo-box
                  name="zone"
                  item-value-path="_id"
                  label="สังกัด"
                  item-label-path="name.en"
                  items="{{zones}}"
                  hidden$="{{adminStaff}}"
                  require="{{!adminStaff}}"
                  always-float-label></vaadin-combo-box>
              </fieldset>
            </div>
            <!-- Hidden Fields -->
            <input name="accessToken" type="hidden" value="{{user.accessToken}}"></input>
            <input name="tokens[0].kind" type="hidden" value="{{user.kind}}"></input>
            <input name="tokens[0].accessToken" type="hidden" value="{{user.accessToken}}"></input>
            <input name="facebook" type="hidden" value="{{user.facebook}}"></input>
          </div>
          <!-- Submit Button -->
          <div class="card-actions">
            <div class="button-holder">
              <paper-button on-tap="_delayedSubmit">
                <paper-spinner id="spinner" hidden></paper-spinner>Submit
              </paper-button>
              <!-- Reset Button -->
              <paper-button on-tap="_reset">Reset</paper-button>
            </div>
          </div>
      </paper-card>
    </form>
  </template>
  <script>
    Polymer({
      is: 'user-edit-page',
      properties: {
        activated: {
          type: Boolean,
          value: false,
          observer: '_activatedChanged'
        },
        _url: {
          type: String,
          computed: '_computeUrl(userId)'
        },
        headers: {
          type: Object,
          value: function() {
            return {
              'Authorization': 'JWT ' + window.token
            };
          }
        },
        _target: {
          type: Object,
          value: function() {
            return this.$.form;
          }
        },
        user: {
          type: Object,
          value: {},
          notify: true
        },
        userId: {
          type: String,
        },
        zones: {
          type: Array,
        },
        gender: {
          type: String,
        },
        type: {
          type: Boolean,
          observer: '_typeChanged',
        },
        student: {
          type: Boolean,
          value: false
        },
        worker: {
          type: Boolean,
          value: false
        },
        staff: {
          type: Boolean,
          value: false
        },
        adminStaff: {
          type: Boolean,
          value: false
        },
        scannerStaff: {
          type: Boolean,
          value: false
        },
        staffStaff: {
          type: Boolean,
          value: false
        },
        workerJobs: {
          type: Array,
          value: ['เกษตรกร‎', 'เจ้าหน้าที่รัฐบาล‎', 'เภสัชกร‎', 'แพทย์', 'โฆษก‎ ', 'โปรแกรมเมอร์', 'กวี‎', 'การประมง‎', 'การฝีมือ‎', 'การส่งเสริมอาชีพ‎', 'ข้าราชการ‎', 'คนขับรถแท็กซี่‎', 'ครู', 'คอลัมนิสต์‎', 'จิตรกร‎', 'ช่างทำเครื่องดนตรี‎', 'ช่างทำผม‎', 'ตำรวจ‎', 'ตุลาการ‎', 'ทนายความ‎', 'ทหาร', 'ธุรกิจส่วนตัว', 'นักเขียน‎', 'นักเขียนบทภาพยนตร์', 'นักเคลื่อนไหว‎', 'นักเศรษฐศาสตร์', 'นักแต่งเพลง', 'นักแปล', 'นักแสดง‎', 'นักโบราณคดี', 'นักโภชนาการ', 'นักกฎหมาย‎', 'นักการเมือง‎', 'นักการกุศล‎', 'นักการทูต‎', 'นักการธนาคาร‎', 'นักการศึกษา‎', 'นักกีฬา‎', 'นักข่าว', 'นักคณิตศาสตร์‎', 'นักจัดรายการวิทยุ‎', 'นักจิตวิทยา', 'นักชีววิทยา‎', 'นักดนตรี‎', 'นักดาราศาสตร์‎', 'นักถ่ายภาพ‎', 'นักธุรกิจ‎', 'นักบวช‎', 'นักบัญชี', 'นักบิน‎', 'นักบินอวกาศ‎', 'นักประชาสัมพันธ์‎', 'นักประดิษฐ์', 'นักประวัติศาสตร์', 'นักประวัติศาสตร์ศิลป์‎', 'นักปรัชญา', 'นักปีนเขา', 'นักผจญภัย‎', 'นักพากย์', 'นักภาษาศาสตร์', 'นักมายากล‎', 'นักร้อง', 'นักวาดการ์ตูน', 'นักวิจารณ์ภาพยนตร์', 'นักวิทยาศาสตร์', 'นักสะสมศิลปะ', 'นักสังคมวิทยา', 'นักสังคมศาสตร์', 'นักสัตววิทยา', 'นักสำรวจ', 'นักสืบ', 'นักหนังสือพิมพ์‎', 'นักอนุรักษ์ธรรมชาติ', 'นักออกแบบ', 'นักออกแบบเสื้อผ้า‎', 'นักออกแบบกราฟิก‎', 'นางแบบ', 'นางงาม', 'นายแบบ', 'บรรณาธิการ', 'บุคคลในวงการคอมพิวเตอร์‎', 'บุคคลในวงการพลศึกษา', 'บุคคลในวงการวรรณกรรม', 'บุคคลด้านสื่อ', 'ผู้เชี่ยวชาญด้านศาสนาพุทธ', 'ผู้กำกับ', 'ผู้กำกับภาพยนตร์', 'ผู้กำกับละครโทรทัศน์‎', 'ผู้จัดพิมพ์ (บุคคล)‎', 'ผู้ประกาศข่าว', 'ผู้พิพากษาไทย‎', 'ผู้มีชื่อเสียง', 'ผู้อำนวยการสร้างภาพยนตร์', 'พยาบาล', 'พิธีกร', 'ฟรีแลนซ์', 'ภูมิสถาปนิก', 'รัฐวิสาหกิจ', 'ว่างงาน', 'วาทยกร', 'วิชาชีพทางด้านสาธารณสุข', 'วิศวกร', 'วีเจ', 'ศิลปิน', 'สถาปนิก', 'อัยการ', 'อาจารย์', 'อาชีพการเดินเรือ', 'อาชีพการบันเทิง', 'อาชีพด้านอาหาร', 'อื่น ๆ']
        },
        academicLevels: {
          type: Array,
          value: ["มัธยมต้น", "มัธยมปลาย", "ปริญญาตรี", "ปริญญาโท", "ปริญญาเอก", "อื่น ๆ"]
        },
        academicLevel: {
          type: String,
          observer: '_onAcademicLevelChanged'
        },
        academicYears: {
          type: Array,
          value: []
        },
        route: {
          type: String,
        },
        activated: {
          type: Boolean,
          value: false,
          observer: '_onActivatedChanged'
        },
      },
      _firstLevelChange: false,
      _toBeAcademicYear: null,
      observers: [
        '_onUserChanged(user)'
      ],
      _computeUrl: function(userId) {
        return window.api + '/api/users/' + userId;
      },
      _onAcademicLevelChanged: function(level) {
        if (!this._firstLevelChange) {
          this.academicYear = -1;
        } else {
          this._firstLevelChange = false;
        }
        level = this.academicLevels[level];
        if (level === 'มัธยมต้น') {
          this.set('academicYears', ["ม.1", "ม.2", "ม.3"]);
        } else if (level === 'มัธยมปลาย') {
          this.set('academicYears', ["ม.4", "ม.5", "ม.6"]);
        } else if (level === 'ปริญญาตรี') {
          this.set('academicYears', ["ปี 1", "ปี 2", "ปี 3", "ปี 4", "ปี 5", "ปี 6", "ปี 7", "ปี 8"]);
        } else if (level === 'ปริญญาโท') {
          this.set('academicYears', ["ปี 1", "ปี 2", "ปี 3", "ปี 4"]);
        } else if (level === 'ปริญญาเอก') {
          this.set('academicYears', ["ปี 1", "ปี 2", "ปี 3", "ปี 4"]);
        } else if (level === 'อื่น ๆ') {
          this.set('academicYears', ["ปี 1", "ปี 2", "ปี 3", "ปี 4", "ปี 5", "ปี6"]);
        } else {
          this.academicYears = [];
        }

        if (this._toBeAcademicYear) {
          this.academicYear = this.academicYears.indexOf(this._toBeAcademicYear);
          this._toBeAcademicYear = null;
        }
      },
      _onActivatedChanged: function(activated) {
				if (activated) {
          this._firstLevelChange = true;
					this.$.userAPI.generateRequest();
				}
      },
      onEnter: function() {
        this.$.form.submit();
      },
      _onUserChanged: function(user) {
        if (!user) return;
        if (user.type === 'Worker') {
          this.workerJob = user.worker.job;
        } else if (user.type === 'Academic') {
          this._toBeAcademicYear = user.academic.year;
          this.academicLevel = this.academicLevels.indexOf(user.academic.level);
        }
      },
      _typeChanged: function(event) {
        this.hideStudent = this.type;
        this.hideWorker = !this.type;
      },
      _delayedSubmit: function(event) {
        var form = this.$.form;
        this.$.spinner.active = true;
        this.$.spinner.hidden = false;
        this.$.form.disabled = true;
        form.submit();
      },
      _reset: function(event) {
        var form = this.$.form;
        this.$.spinner.active = false;
        this.$.spinner.hidden = true;
        form.reset();
      },
      _presubmit: function(event) {
        this.$.form.request.method = 'PUT';
        this.$.code.invalid = false;
        this.$.password.invalid = false;
        this.$.confirmPassword.invalid = false;
        for (field in this.$.form.request.body) {
          if (typeof this.$.form.request.body[field] === 'undefined') {
            delete this.$.form.request.body[field];
          }
        }
        if (this.$.form.request.body.password !== this.$.form.request.body.confirmPassword) {
          this.$.password.invalid = true;
          this.$.confirmPassword.invalid = true;

          this.$.spinner.active = false;
          this.$.spinner.hidden = true;
          return event.preventDefault();
        }
        this.$.form.request.body.gender = this.male ? 'Male' : (this.female ? 'Female': 'Other');
        this.$.form.request.body.type = this.student ? 'Academic' : (this.worker ? 'Worker' : 'Staff');
        if (this.$.form.request.body.type === 'Staff') {
          this.$.form.request.body.staff = this.adminStaff ? 'Admin' : (this.scannerStaff ? 'Scanner' : 'Staff');
        } else {
          delete this.$.form.request.body.staff;
        }
      },
      _response: function(e) {
        this.set('user', null);
        if (e.detail.response.success) {
          this.$.password.value = null;
          this.$.confirmPassword.value = null;
          this.$.spinner.active = false;
          this.$.spinner.hidden = true;

					window.history.pushState({}, null, '/user/' + this.userId + '/show/');
          window.dispatchEvent(new CustomEvent('location-changed'));
        }
      },
      _error: function(e) {
        this.$.spinner.active = false;
        this.$.spinner.hidden = true;
      }
    });
  </script>
</dom-module>
