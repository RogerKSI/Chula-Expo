<!-- Libery -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Web Component -->
<link rel="import" href="../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../../bower_components/iron-data-table/data-table-column.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../ticket-api/ticket-api.html">

<dom-module id="ticket-list">
  <template>
    <ticket-api id="api" activity-id="[[activityId]]" round-id="[[roundId]]" tickets="{{tickets}}"></ticket-api>
    <iron-data-table items="[[tickets]]">
      <data-table-column name="#" width="50px" flex="0">
        <template>[[index]]</template>
      </data-table-column>
      <data-table-column name="User">
        <template>[[item.user.name]]</template>
      </data-table-column>
      <data-table-column name="Create">
        <template>[[_computeCreateAtDate(item.createAt)]]</template>
      </data-table-column>
      <data-table-column name="Status" width="24px">
        <template>
          <iron-icon icon="[[_computeChecked(item.checked)]]"></iron-icon>
        </template>
      </data-table-column>
      <data-table-column name="" width="52px">
        <template>
          <paper-icon-button icon="icons:autorenew" target-id$="[[item._id]]" on-tap="_onToggleClick"></paper-icon-button>
          <paper-icon-button icon="icons:delete" target-id$="[[item._id]]" on-tap="_onRemoveTicket"></paper-icon-button>
        </template>
      </data-table-column>
    </iron-data-table>
    <paper-dialog id="toggleDialog" on-iron-overlay-closed="_onToggle">
      <h2>Are you sure to toggle this ticket?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus>Yes</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="deleteDialog" on-iron-overlay-closed="_onRemove">
      <h2>Are you sure to delete this ticket?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus>Yes</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'ticket-list',
      properties: {
        _url: {
          type: String,
          value: function() {
            return window.api + '/api/'
          }
        },
        activityId: {
          type: String,
          value: ''
        },
        roundId: {
          type: String,
          value: ''
        },
        tickets: {
          type: Array,
          value: []
        },
      },
      _removeId: null,
      _toggleId: null,
      generateRequest: function() {
        return this.$.api.generateRequest();
      },
      _computeCreateAtDate: function(createAt) {
        return moment.utc(createAt).local().format('D MMM, HH:mm');
      },
      _onToggleClick: function(e) {
        this._toggleId = e.target.getAttribute('target-id');
        this.$.toggleDialog.open();
      },
      _onToggle: function(e) {
        if(event.detail.confirmed) {
          var url = window.api + '/api/activities/' + this.activityId + '/rounds/' + this.roundId + '/tickets/' + this._toggleId + '/toggle';
          this._toggleId = null;

          setTimeout(function () {
            var req = new XMLHttpRequest();
            req.open('POST', encodeURI(url));
            req.setRequestHeader('Authorization', 'JWT ' + window.token);
            req.onload = function() {
              if (req.status === 200) {
                this.$.api.generateRequest();
              }
            }.bind(this);
            req.send();
          }.bind(this), 300);
        }
      },
      _onRemoveTicket: function(e) {
        this._removeId = e.target.getAttribute('target-id');
        this.$.deleteDialog.open();
      },
      _onRemove: function(e) {
        if(event.detail.confirmed) {
          var url = window.api + '/api/activities/' + this.activityId + '/rounds/' + this.roundId + '/tickets/' + this._removeId;
          this._removeId = null;

          setTimeout(function () {
            var req = new XMLHttpRequest();
            req.open('DELETE', encodeURI(url));
            req.setRequestHeader('Authorization', 'JWT ' + window.token);
            req.onload = function() {
              if (req.status === 202) {
                this.$.api.generateRequest();
              }
            }.bind(this);
            req.send();
          }.bind(this), 300);
        }
      },
      _computeChecked: function(checked) {
        return checked ? 'icons:radio-button-checked' : 'icons:radio-button-unchecked';
      }
    });
  </script>
</dom-module>
