<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="user-api">
  <template>
    <iron-ajax
      id="api"
      url="[[url]]"
      headers="[[headers]]"
      params="[[params]]"
      on-response="_handleResponse"
      on-error="_handleError"
      handle-as="json"
    ></iron-ajax>
  </template>
  <script>
    Polymer({
      is: 'user-api',
      properties: {
        url: {
          type: String,
          value: function () {
            return window.api + '/api/users';
          },
          computed: '_computeUrl(targetId)'
        },
        params: {
          type: Object,
          value: {}
        },
        headers: {
          type: Object,
          // value: {}
          value: function() {
            return { 'Authorization': 'JWT ' + window.token };
          }
        },
        targetId: {
          type: String,
          value: ''
        },
        page: {
          type: Number,
          value: 1
        },
        pageSize: {
          type: Number,
          value: 10
        },
        fields: {
          type: String,
          value: ''
        },
        search: {
          type: String
        },
        /*
          Output Data
        */
        users: {
          type: Array,
          value: [],
          notify: true,
        },
        user: {
          type: Object,
          notify: true,
        },
        loading: {
          type: Boolean,
          value: false,
          notify: true
        },
        error: {
          type: Object,
          value: {}
        },
        totalPages: {
          type: Number,
          notify: true,
        }
      },
      
      ready: function() {
        document.addEventListener('token', function(e) {
          var token = e.detail.token;
          if (!token) {
            return;
          }

          this.headers = {
            'Authorization': 'JWT ' + token
          };
        }.bind(this));
      },
      generateRequest: function() {
        if (this.pageSize === 0) {
          this.set('params.limit', null);
          this.set('params.skip', this.page);
        } else {
          this.set('params.limit', this.pageSize);
          this.set('params.skip', (this.page - 1) * this.pageSize);
        }

        if (this.fields) {
          this.set('params.fields', this.fields);
        }

        if (typeof this.search !== "undefined") {
          this.set('params.search', this.search.trim());
        }

        this.set('loading', true);
        return this.$.api.generateRequest();
      },
      _handleResponse: function(event) {
        this.set('loading', false);
        if(event.detail.response) {
          if (event.detail.response.success) {
            if (this.targetId) {
              this.user = event.detail.response.results;
            } else {
              this.users = event.detail.response.results;
              console.log(Math.ceil(event.detail.response.queryInfo.total / this.pageSize));
              this.set('totalPages', Math.ceil(event.detail.response.queryInfo.total / this.pageSize));
            }
          } else {
            this.error = event.detail.response.errors;
          }
        }
      },
      _handleError: function(event) {
        this.set('loading', false);
        var response = event.detail.request.xhr.response;
        if (!response.success) {
          this.error = response.errors;
        }
      },
      _computeUrl: function(targetId) {
        if (targetId) {
          return window.api + '/api/users/' + targetId;
        } else {
          return window.api + '/api/users';
        }
      }
    })
  </script>
</dom-module>